activations:
  - role: system
    activation: implementation
    content: |
      You are an **Execution Agent** responsible for completing assignments by producing structured messages in three phases:
      1️⃣ **Plan** → 2️⃣ **Execution** → 3️⃣ **Summary**
      
      You focus now is to **Execute** the provided step.
        
      ---

  - role: user
    activation: memory
    content: |
      Earlier execution produced the following values:
      
      {% for value in memory %}
      
      - **`{{ value.identifier | raw }}`**
      
      {{ ident(value.description, 2) | raw }}
      
      
        ```json
        
      {{ ident(value.model, 4) | raw }}
        
        ```
      
      ---
      {% endfor %}

  - role: user
    activation: implementation
    content: |
      Here is a set of documentation that will help you understand how to interact with the services and available operations.
      
      {% for srv in services %}
      - `{{ srv["service"].slug | raw }}`
      
        ```md      
      
      {{ ident( call(srv["service"], "getReadme", 0), 4) | raw }}
      
      
        ```
      
        Here are all available operations for this service:
      
        {% for opr in srv["operations"] %}
        
        - `{{ opr.operation | raw }}`
        
        ```md
      
      {{ ident( call(opr, "getDocumentation", 0), 6) | raw }}    
      
        ```
        
        {% endfor %}
      
      {% endfor %}
      
      ---      

  - role: user
    activation: implementation
    content: |
      Use the following base class and interfaces:
      
        ```java
          package com.gentoro.onemcp.compiler;
      
          import com.fasterxml.jackson.databind.JsonNode;
          import com.fasterxml.jackson.databind.ObjectMapper;
          import java.util.Set;
          import okhttp3.OkHttpClient;
          import okhttp3.Request;
          import okhttp3.Response;
          import okhttp3.ResponseBody;
          import com.gentoro.onemcp.memory.ValueStore;
      
          public abstract class SnippetBase {
      
            /**
            * When interacting with JSON Objects, use this ObjectMapper instance.
            * @return Valid instance of ObjectMapper.
            */
            public com.fasterxml.jackson.databind.ObjectMapper getObjectMapper();
      
      
            /**
            * Use this service to retrieve and store values.  
            * @return Valid instance of ValueStore.
            */
            public com.gentoro.onemcp.memory.ValueStore getValueStore()
      
            /**
            * Entry point for snippet execution.
            * @return List of value slugs modified / created by the snippet.
            */
            public abstract Set<String> run();
      
            /**
            * Retrieve a valid instance okhttp Request Builder, already configured to communicate with the specified service.
            * @param serviceSlug Slug / name of the service to be used. Peek from the provided list.    
            * @param operationName Name of the operation present in the service. Peek from the provided list.    
            * @return Valid and configured instance of okhttp3.Request.Builder.    
            */
            public okhttp3.Request.Builder initRequest(String serviceSlug, String operationName);
      
            /**
            * Execute a request, targeting a given service and return the response.
            * @param serviceSlug Slug / name of the service to be used. Peek from the provided list.    
            * @param requestBuilder The request to be executed.    
            * @return Result of the request execution.    
            */      
            public okhttp3.Response executeRequest(String serviceSlug, okhttp3.Request.Builder requestBuilder);
          }
        ```
      
        ```java
        /**
        * Keeps track of a dictionary of values accessible throughout the execution
        */
        package com.gentoro.onemcp.memory;
      
        public interface ValueStore {
          // place a new value entry in memory
          // should the value already exist, it will be replaced
          void put(Value entry);
        
          // retrieve a value entry by its identifier
          // if the entry does not exist, return null
          Value get(String id);
        
          // retrieve a list of value entries by their identifiers
          // if an entry does not exist, it will be omitted from the list
          // if no identifiers are provided, all entries are listed
          List<Value> getAll(String... ids);
        }
      
        /**
        * Represents a single value entry in the store.
        *
        * @param identifier - a unique name that identifies the value.
        * @param value - the value itself.
        * @param description - a concise summary explaining what the variable represents.
        *
        */
      
        package com.gentoro.onemcp.memory;
        ...
        public class Value {
        // no args constructor
        public Value() {}
        // all args constructor
        public Value(
          // unique identifier of the entry
          String identifier,
          // actual value of the entry
          Object content,
          // detailed description of the entry
          String description) {...}
      
        public String getIdentifier() {...}
        public Object getDescription() {...}
        public Object getContent() {...}
        public Object getModel() {...}
      
        public void setIdentifier(String identifier) {...}
        public void getDescription(String description) {...}
        public void setContent(Object value) {...}
        }
        ```
      
      ---

  - role: user
    activation: implementation
    content: |
      Here is a snippet template you can use as a starting point.
      
      Use this only as a guide for your implementation, and **do not copy it verbatim**.
      
      > **Note:** Remember you are autonomous, and you must write the code yourself, without any help or clarification. Provided documentation should be used as the source of true.
      
      ```java
          // always use the following package declaration
          package com.gentoro.onemcp.snippets;
      
          import com.gentoro.onemcp.compiler.SnippetBase;
          import okhttp3.Request;
          import okhttp3.Response;
          import okhttp3.ResponseBody;
          import com.fasterxml.jackson.databind.JsonNode;
      
          // add here the necessary imports
      
          // declare the public class with a mindful naming. It must extend the base class SnippetBase          
          public class YourClassNameHere extends SnippetBase {
      
            // Method run is the entry point for the execution of the snippet, always declare this way.
            @Override
            public Set<String> run() {
              try {
                // You logic goes here.
      
                // use library OkHttp to build requests to a service, e.g:
                //provide the service slug, and the name of the operation.
                // a configured instance of Request.Builder will be returned.
                Request.Builder requestBuilder = initRequest("service_slug", "saveEntity");
    
                // use the method `executeRequest` to execute the request, and return the response.
                // provide the target service slug and the request builder.
                try (Response response = executeRequest("service_slug", requestBuilder)) {
                if (!response.isSuccessful()) {
                  // handle errors here, e.g:️      
                  throw new RuntimeException("Request failed: " + response.code() + " " + response.message());
                }
                
                // Use jackson to parse the response body, e.g:                
                ResponseBody body = response.body();
                JsonNode json = getObjectMapper().readTree(body.string());
      
                // Use `System.out.println` to print debug messages. These will be captured and reported to the execution agent. 
      
                // add your logic here,
                // store and retrieve content from value store, e.g: `getValueStore().get("variable_name")` or `getValueStore().put(new MemoryEntry("variable_name", value, "description of your variable")`.

                // return the list of variables (names) created / changed
                // e.g: return Set.of("variable_name");
              } catch (Exception e) {
                // always protect your code with try-catch blocks, and report any errors as runtime exceptions.
                throw new RuntimeException("Failure while running snippet.", e);
              }
            }

          }
      ```
      
      > **Note:** While generating the snippet, use `System.out.println` to print debug messages. These will be captured and reported to the execution agent.
      
      ---

  - role: user
    activation: implementation
    content: |
      With all the provided information, here is the description of the step to be executed:
      
      ```md
      
      {{ ident(stepDescription, 2) | raw }}
      
      ```
      
      ---
      
      ** Constraints **:
      
      * The provided snippet must be **fully compilable Java code**.
      * The provided snippet must be **self-contained**, using available libraries and documentation. Do not ask for additional information, clarification or placeholders for missing information.
      * Snippet should always return the list of variables (names) created / changed.
      * Snippet must be complete, containing all required imports, package, and class declarations. Use the **provide snippet template**, and **do not copy it verbatim**.
      
      ---
      
      ** VERY IMPORTANT **:
      
      {% if mode == 'TEMPLATE' %}
      The response **MUST** comply with the following **FORMAT**:
      
      {{ typeTemplate | raw }}
      {% else %}
      Once you are done with the reasoning, you **MUST** call the Tool / Function named `StepImplementation` to share the generated snippet, qualified class name and the reasoning behind it.
      {% endif %}
      
      ---    

  - role: assistant
    activation: attempt
    content: |
      
      ```java
      
      {{ snippet | raw }}
      
      ```

  - role: assistant
    activation: attempt
    content: |
      
      System reported the following error:
      
      ```
      
      {{ ident( errors, 2) | raw }}
      
      ```
      
      Fix the above error and try again.
      
      ---
      
      ** VERY IMPORTANT **:
      
      {% if mode == 'TEMPLATE' %}
      The response **MUST** comply with the following **FORMAT**:
      
      {{ typeTemplate | raw }}
      {% else %}
      Once you are done with the reasoning, you **MUST** call the Tool / Function named `StepImplementation` to share the generated snippet, qualified class name and the reasoning behind it.
      {% endif %}
      
      ---    
