openapi: 3.0.3
info:
  title: IoT Device Management API
  description: |
    A comprehensive API for managing IoT devices, sensors, telemetry data, and alerts.
    This API provides operations to register devices, configure sensors, query telemetry streams,
    manage device groups, and handle alert notifications.
    
    ## Key Features
    - **Device Management**: Register, update, and monitor IoT devices
    - **Sensor Configuration**: Manage sensors attached to devices
    - **Telemetry Queries**: Query time-series sensor data with aggregation
    - **Alert Management**: Configure and monitor threshold-based alerts
    - **Device Groups**: Organize devices hierarchically for bulk operations
    
    ## Core Entities
    - **Devices**: Physical IoT devices with firmware and connectivity status
    - **Sensors**: Individual sensors measuring temperature, humidity, pressure, etc.
    - **Telemetry**: Time-series data streams from sensors
    - **Alerts**: Threshold-based notifications and warnings
    - **Groups**: Hierarchical device groupings
  version: 1.0.0
servers:
  - url: https://api.example.com/iot
    description: Production server
tags:
  - name: Devices
    description: Device management operations
  - name: Sensors
    description: Sensor configuration operations
  - name: Telemetry
    description: Telemetry data queries
  - name: Alerts
    description: Alert management operations
  - name: Groups
    description: Device group operations
  - name: System
    description: System operations

paths:
  /devices:
    get:
      operationId: listDevices
      summary: List all devices
      description: Retrieve a paginated list of all registered IoT devices with optional filtering
      tags:
        - Devices
      parameters:
        - name: group_id
          in: query
          description: Filter devices by group
          required: false
          schema:
            type: string
        - name: status
          in: query
          description: Filter by device status
          required: false
          schema:
            type: string
            enum: [online, offline, error, maintenance]
        - name: firmware_version
          in: query
          description: Filter by firmware version
          required: false
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of devices to return
          required: false
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          description: Number of devices to skip
          required: false
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of devices retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevicesResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      operationId: registerDevice
      summary: Register a new IoT device
      description: Register a new IoT device in the system
      tags:
        - Devices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceRegistrationRequest'
      responses:
        '201':
          description: Device registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceResponse'
        '400':
          description: Invalid device data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /devices/{device_id}:
    get:
      operationId: getDevice
      summary: Get device details
      description: Retrieve detailed information about a specific device including sensor list
      tags:
        - Devices
      parameters:
        - name: device_id
          in: path
          required: true
          description: Unique device identifier
          schema:
            type: string
      responses:
        '200':
          description: Device details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    patch:
      operationId: updateDeviceStatus
      summary: Update device status
      description: Update device connectivity status or put device in maintenance mode
      tags:
        - Devices
      parameters:
        - name: device_id
          in: path
          required: true
          description: Unique device identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceStatusUpdateRequest'
      responses:
        '200':
          description: Device status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceResponse'
        '400':
          description: Invalid status data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /devices/{device_id}/sensors:
    get:
      operationId: listDeviceSensors
      summary: List sensors for a device
      description: Retrieve all sensors attached to a specific device
      tags:
        - Sensors
      parameters:
        - name: device_id
          in: path
          required: true
          description: Unique device identifier
          schema:
            type: string
        - name: sensor_type
          in: query
          description: Filter by sensor type
          required: false
          schema:
            type: string
            enum: [temperature, humidity, pressure, motion, light, air_quality]
      responses:
        '200':
          description: List of sensors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SensorsResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      operationId: addSensor
      summary: Add a sensor to a device
      description: Register a new sensor on an existing device
      tags:
        - Sensors
      parameters:
        - name: device_id
          in: path
          required: true
          description: Unique device identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SensorRegistrationRequest'
      responses:
        '201':
          description: Sensor added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SensorResponse'
        '400':
          description: Invalid sensor data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /telemetry/{sensor_id}:
    get:
      operationId: queryTelemetry
      summary: Query telemetry data
      description: Retrieve time-series telemetry data from a sensor with optional aggregation
      tags:
        - Telemetry
      parameters:
        - name: sensor_id
          in: path
          required: true
          description: Unique sensor identifier
          schema:
            type: string
        - name: start_time
          in: query
          description: Start time for data range (ISO 8601)
          required: true
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: End time for data range (ISO 8601)
          required: true
          schema:
            type: string
            format: date-time
        - name: interval
          in: query
          description: Aggregation interval (e.g., 1m, 5m, 1h, 1d)
          required: false
          schema:
            type: string
        - name: aggregation
          in: query
          description: Aggregation function
          required: false
          schema:
            type: string
            enum: [avg, min, max, sum, count]
            default: avg
      responses:
        '200':
          description: Telemetry data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Sensor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /alerts:
    get:
      operationId: listAlerts
      summary: List active alerts
      description: Retrieve all active alerts with optional filtering
      tags:
        - Alerts
      parameters:
        - name: device_id
          in: query
          description: Filter alerts by device
          required: false
          schema:
            type: string
        - name: severity
          in: query
          description: Filter by alert severity
          required: false
          schema:
            type: string
            enum: [critical, warning, info]
        - name: status
          in: query
          description: Filter by alert status
          required: false
          schema:
            type: string
            enum: [active, acknowledged, resolved]
      responses:
        '200':
          description: List of alerts retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      operationId: createAlertRule
      summary: Create an alert rule
      description: Define a threshold-based alert rule for a sensor
      tags:
        - Alerts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertRuleRequest'
      responses:
        '201':
          description: Alert rule created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRuleResponse'
        '400':
          description: Invalid alert rule data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /groups:
    get:
      operationId: listGroups
      summary: List device groups
      description: Retrieve all device groups with hierarchy information
      tags:
        - Groups
      parameters:
        - name: parent_group_id
          in: query
          description: Filter groups by parent group
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of groups retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      operationId: createGroup
      summary: Create a device group
      description: Create a new device group, optionally as a child of another group
      tags:
        - Groups
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GroupRequest'
      responses:
        '201':
          description: Group created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          description: Invalid group data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: Check the health status of the API
      tags:
        - System
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

components:
  schemas:
    DeviceRegistrationRequest:
      type: object
      required:
        - device_id
        - name
        - device_type
      properties:
        device_id:
          type: string
          description: Unique device identifier (MAC address or serial number)
          example: "DEV-001-ABC123"
        name:
          type: string
          description: Human-readable device name
          example: "Warehouse Temperature Monitor"
        device_type:
          type: string
          description: Type of IoT device
          example: "gateway"
        firmware_version:
          type: string
          description: Current firmware version
          example: "2.1.3"
        location:
          type: string
          description: Physical location description
          example: "Building A, Floor 2, Room 201"
        group_id:
          type: string
          description: Optional device group identifier
          example: "GRP-WAREHOUSE-01"

    DeviceStatusUpdateRequest:
      type: object
      properties:
        status:
          type: string
          enum: [online, offline, error, maintenance]
          description: Device connectivity status
        last_seen:
          type: string
          format: date-time
          description: Last communication timestamp
        metadata:
          type: object
          description: Additional device metadata
          additionalProperties: true

    DeviceResponse:
      type: object
      properties:
        device_id:
          type: string
          description: Unique device identifier
        name:
          type: string
          description: Device name
        device_type:
          type: string
          description: Type of device
        firmware_version:
          type: string
          description: Firmware version
        status:
          type: string
          enum: [online, offline, error, maintenance]
          description: Current device status
        location:
          type: string
          description: Physical location
        group_id:
          type: string
          description: Device group identifier
        last_seen:
          type: string
          format: date-time
          description: Last communication timestamp
        sensors:
          type: array
          items:
            $ref: '#/components/schemas/SensorSummary'
        created_at:
          type: string
          format: date-time
          description: When device was registered
        updated_at:
          type: string
          format: date-time
          description: When device was last updated

    DevicesResponse:
      type: object
      properties:
        devices:
          type: array
          items:
            $ref: '#/components/schemas/DeviceResponse'
        total:
          type: integer
          description: Total number of devices
        limit:
          type: integer
          description: Maximum devices returned
        offset:
          type: integer
          description: Number of devices skipped

    SensorRegistrationRequest:
      type: object
      required:
        - sensor_id
        - sensor_type
        - unit
      properties:
        sensor_id:
          type: string
          description: Unique sensor identifier
          example: "SENS-001-TEMP"
        sensor_type:
          type: string
          enum: [temperature, humidity, pressure, motion, light, air_quality]
          description: Type of sensor
        unit:
          type: string
          description: Measurement unit
          example: "celsius"
        calibration_offset:
          type: number
          format: float
          description: Calibration offset value
          example: 0.5
        sampling_rate:
          type: integer
          description: Sampling rate in seconds
          example: 60

    SensorSummary:
      type: object
      properties:
        sensor_id:
          type: string
          description: Unique sensor identifier
        sensor_type:
          type: string
          description: Type of sensor
        unit:
          type: string
          description: Measurement unit
        last_reading:
          type: number
          format: float
          description: Most recent sensor reading
        last_reading_time:
          type: string
          format: date-time
          description: Timestamp of last reading

    SensorResponse:
      type: object
      properties:
        sensor_id:
          type: string
          description: Unique sensor identifier
        device_id:
          type: string
          description: Parent device identifier
        sensor_type:
          type: string
          description: Type of sensor
        unit:
          type: string
          description: Measurement unit
        calibration_offset:
          type: number
          format: float
          description: Calibration offset
        sampling_rate:
          type: integer
          description: Sampling rate in seconds
        last_reading:
          type: number
          format: float
          description: Most recent reading
        last_reading_time:
          type: string
          format: date-time
          description: Timestamp of last reading
        created_at:
          type: string
          format: date-time
          description: When sensor was registered

    SensorsResponse:
      type: object
      properties:
        sensors:
          type: array
          items:
            $ref: '#/components/schemas/SensorResponse'
        total:
          type: integer
          description: Total number of sensors

    TelemetryDataPoint:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Measurement timestamp
        value:
          type: number
          format: float
          description: Sensor reading value
        quality:
          type: string
          enum: [good, fair, poor, invalid]
          description: Data quality indicator

    TelemetryResponse:
      type: object
      properties:
        sensor_id:
          type: string
          description: Sensor identifier
        sensor_type:
          type: string
          description: Type of sensor
        unit:
          type: string
          description: Measurement unit
        start_time:
          type: string
          format: date-time
          description: Query start time
        end_time:
          type: string
          format: date-time
          description: Query end time
        interval:
          type: string
          description: Aggregation interval used
        aggregation:
          type: string
          description: Aggregation function used
        data_points:
          type: array
          items:
            $ref: '#/components/schemas/TelemetryDataPoint'
        summary:
          type: object
          properties:
            count:
              type: integer
              description: Number of data points
            min:
              type: number
              format: float
              description: Minimum value
            max:
              type: number
              format: float
              description: Maximum value
            avg:
              type: number
              format: float
              description: Average value

    AlertRuleRequest:
      type: object
      required:
        - sensor_id
        - condition
        - threshold
        - severity
      properties:
        sensor_id:
          type: string
          description: Sensor to monitor
        condition:
          type: string
          enum: [greater_than, less_than, equals, not_equals, between]
          description: Threshold condition
        threshold:
          type: number
          format: float
          description: Threshold value (or array for 'between')
        severity:
          type: string
          enum: [critical, warning, info]
          description: Alert severity level
        name:
          type: string
          description: Human-readable alert rule name
        enabled:
          type: boolean
          description: Whether rule is active
          default: true

    AlertRuleResponse:
      type: object
      properties:
        rule_id:
          type: string
          description: Unique alert rule identifier
        sensor_id:
          type: string
          description: Monitored sensor
        condition:
          type: string
          description: Threshold condition
        threshold:
          type: number
          format: float
          description: Threshold value
        severity:
          type: string
          description: Alert severity
        name:
          type: string
          description: Alert rule name
        enabled:
          type: boolean
          description: Whether rule is active
        created_at:
          type: string
          format: date-time
          description: When rule was created

    Alert:
      type: object
      properties:
        alert_id:
          type: string
          description: Unique alert identifier
        rule_id:
          type: string
          description: Alert rule that triggered this alert
        device_id:
          type: string
          description: Device where alert occurred
        sensor_id:
          type: string
          description: Sensor that triggered alert
        severity:
          type: string
          enum: [critical, warning, info]
          description: Alert severity
        status:
          type: string
          enum: [active, acknowledged, resolved]
          description: Alert status
        message:
          type: string
          description: Human-readable alert message
        value:
          type: number
          format: float
          description: Sensor value that triggered alert
        threshold:
          type: number
          format: float
          description: Threshold value
        triggered_at:
          type: string
          format: date-time
          description: When alert was triggered
        acknowledged_at:
          type: string
          format: date-time
          description: When alert was acknowledged
        resolved_at:
          type: string
          format: date-time
          description: When alert was resolved

    AlertsResponse:
      type: object
      properties:
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        total:
          type: integer
          description: Total number of alerts

    GroupRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Group name
          example: "Warehouse Sensors"
        description:
          type: string
          description: Group description
        parent_group_id:
          type: string
          description: Parent group for hierarchical organization
        tags:
          type: array
          items:
            type: string
          description: Tags for grouping and filtering

    GroupResponse:
      type: object
      properties:
        group_id:
          type: string
          description: Unique group identifier
        name:
          type: string
          description: Group name
        description:
          type: string
          description: Group description
        parent_group_id:
          type: string
          description: Parent group identifier
        child_groups:
          type: array
          items:
            type: string
          description: Child group identifiers
        device_count:
          type: integer
          description: Number of devices in this group
        tags:
          type: array
          items:
            type: string
          description: Group tags
        created_at:
          type: string
          format: date-time
          description: When group was created

    GroupsResponse:
      type: object
      properties:
        groups:
          type: array
          items:
            $ref: '#/components/schemas/GroupResponse'

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "DEVICE_NOT_FOUND"
            message:
              type: string
              example: "Device with ID DEV-001 not found"
            details:
              type: object
              description: Additional error context
        timestamp:
          type: string
          format: date-time
          description: When the error occurred

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "1.0.0"
        connected_devices:
          type: integer
          description: Number of currently connected devices
        active_alerts:
          type: integer
          description: Number of active alerts

